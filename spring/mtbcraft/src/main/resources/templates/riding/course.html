<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="header"></head>
<div id="sub_img"></div>
<!-- 위는 로컬에 적용하는 KEY, 아래는 서버에 적용하는 KEY입니다. 로컬에서는 상단KEY를 쓰고 아래 KEY를 주석처리해주세요.-->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=75b139a908cf5a67ae5c093565896a18&libraries=services"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=dbb047c9e9b46e285f76df6669c00d7f&libraries=services"></script>
<div>
	<label for="chk_DA">위험지역 보기</label> <input id="chk_DA" name="DA" type="checkbox">
	<input id="post_DA" type="button" value="위험지역등록하기">
	<div id="box_post_DA">
		<form id="form_post_DA" action="/riding/DA" method="post">
			<label>위도</label><input type="text" id="DA_Lat" name="da_latitude" size="18">
			<label>경도</label><input type="text" id="DA_Lon" name="da_longitude" size="18">
			<label>등록주소</label><input type="text" id="DA_addr" name="da_addr" size="8">
			<label>한줄평</label><input type="text" id="DA_content" name="da_content" size="40">
			<label>이미지첨부</label><input type="file" id="DA_Image" name="da_image" accept="image/*">
			<input type="hidden" id="DARider" name="da_rider">
			<input type="hidden" id="DABox" value="off">
		</form>
		<button id="bt_post_DA">등록신청하기</button>
		<button id="bt_post_DA_Cancel">취소</button>
	</div>
</div>
<div id="myInfoBox">
	<div id="myRecords">
	<h2>나의 기록</h2>
	<ul>
		<li class="li_rr" th:each="record : ${ridingrecords}" th:id="${record.rr_num}">
			<span th:text="${record.rr_area}"></span>
			<span th:text="${record.rr_gpx}"></span>
		</li>
	</ul>
	</div>
	<div id="myScraps">
	<h2>나의 스크랩 코스</h2>
		<ul>
			<li "li_sc" th:each="course : ${scrapcourses}" th:id="${course.c_num}" >
				<span th:text="${course.c_area}"></span>
				<span>난이도</span>
				<span th:text="${course.c_level}"></span>
			</li>
		</ul>
	</div>
</div>
<div id="map" style="width:83%;height:350px;"></div>
<div "courseInfo">
	<h2>선택한 코스 정보</h2>
	<div id="courseInfo"></div>
	<button id="bt_Open" onclick="changeOpen()"></button>
	<input type="hidden" id="bt_rr_open">
	<input type="hidden" id="bt_rr_num">
</div>
	
<script>
	var da_makers = []; // 위험지역을 담을 배열
	
	var mapContainer = document.getElementById('map'), // 지도를 표시할 div 
    mapOption = { 
        center: new kakao.maps.LatLng(35.89617906303501, 128.62171907592318), // 지도의 중심좌표
        level: 5 // 지도의 확대 레벨
    };
	var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
	
	$(document).ready(function() {
		userId = $("#nav_t_login ul li b span").html();
		$('#DARider').val(userId);
		$('#box_post_DA').hide();
		
		var polyline; //폴리라인을 생성합니다
		$(".li_rr").click(function(){
			$.ajax({
				url : "/getGpxFileByRR_Num",
				type : "GET",
				data : {rr_num : this.id},
				dataType : "json",
				cache : false,
				success : function(data) {
					if(polyline){
						polyline.setMap(null);
					}
					
					var point = data.infos;
					var linePath = [];
					
					// 지도를 재설정할 범위정보를 가지고 있을 LatLngBounds 객체를 생성합니다
					var bounds = new kakao.maps.LatLngBounds();
					
					for(var i=0;i<point.length;i++){
						var location = new kakao.maps.LatLng(point[i].lat, point[i].lon);
						linePath.push(location);
						bounds.extend(location);
					}
					// 지도에 표시할 선을 생성합니다
					polyline = new kakao.maps.Polyline({
					    path: linePath, // 선을 구성하는 좌표배열 입니다
					    strokeWeight: 7, // 선의 두께 입니다
					    strokeColor: "#FF6600", // 선의 색깔입니다
					    strokeOpacity: 0.5, // 선의 불투명도 입니다 1에서 0 사이의 값이며 0에 가까울수록 투명합니다
					    strokeStyle: 'solid' // 선의 스타일입니다
					});
					// 지도에 선을 표시합니다 
					polyline.setMap(map);
					// 맵을 이동시킵니다.
					map.setBounds(bounds);
				}
			});
			$.ajax({
				url : "/getRidingRecordByRR_Num",
				type : "GET",
				data : {rr_num : this.id},
				dataType : "json",
				cache : false, 
				success : function(data) {
					var str = "라이딩 일시 : "+data.rr_date
						+ "전체거리 : "+data.rr_distance
						+ "위치 : "+data.rr_area
						+ "주행시간 : "+data.rr_distance
						+ "휴식시간 : "+data.rr_distance
						+ "최고속도 : "+data.rr_topspeed
						+ "평균속도 : "+data.rr_distance
						+ "획득고도 : "+data.rr_high;
					$('#courseInfo').html(str);
					$("#bt_rr_open").val(data.rr_open);
					$("#bt_rr_num").val(data.rr_num);
					if(data.rr_open==1){
						$('#bt_Open').text("비공개로 전환하기");
					}else{
						$('#bt_Open').text("공개로 전환하기");
					}
						
				}
			});
		});
		
		$(".li_sc").click(function(){//스크랩코스 클릭시 처리할 함수
			alert(this.id);
		});
		
		$("#chk_DA").click(function(){
			if( $("#chk_DA").is(":checked") ){
				da_makers = [];
				$.ajax({
					url : "/riding/DA",
					type : "GET",
					cache : false,
					success : function(data) {
						for (var i = 0; i < data.length; i ++) {
						    // 마커를 생성합니다
						    var marker = new kakao.maps.Marker({
						        map: map, // 마커를 표시할 지도
						        position: new kakao.maps.LatLng(data[i].da_latitude, data[i].da_longitude) // 마커의 위치
						    });
						    
						    da_makers.push(marker);

						    // 마커에 표시할 인포윈도우를 생성합니다 
						    var infowindow = new kakao.maps.InfoWindow({
						        content: data[i].da_content // 인포윈도우에 표시할 내용
						    });

						    // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다
						    // 이벤트 리스너로는 클로저를 만들어 등록합니다 
						    // for문에서 클로저를 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
						    kakao.maps.event.addListener(marker, 'mouseover', makeOverListener(map, marker, infowindow));
						    kakao.maps.event.addListener(marker, 'mouseout', makeOutListener(infowindow));
						}
					}
				});			
			}else{
				hideMarkers();
			}
		});
		
		
		$("#bt_post_DA").click(function(){
			$("#form_post_DA").submit();
		});
		//위험지역등록버튼을 눌렀을 때
		$("#post_DA").click(function(){
			$('#box_post_DA').show();
			$('#DABox').val("on");
			
			// 지도를 클릭한 위치에 표출할 마커입니다
			var da_Point = new kakao.maps.Marker({ 
			    // 지도 중심좌표에 마커를 생성합니다 
			    position: map.getCenter() 
			}); 
			
			// 주소-좌표 변환 객체를 생성합니다
			var geocoder = new kakao.maps.services.Geocoder();
			
			// 지도를 클릭하면 마지막 파라미터로 넘어온 함수를 호출합니다
			kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
				
			    // 클릭한 위도, 경도 정보를 가져옵니다 
			    var latlng = mouseEvent.latLng; 
			    
				if($('#DABox').val()=="off"){
					da_Point.setMap(null);
				}else if($('#DABox').val()=="on"){
					 // 마커 위치를 클릭한 위치로 옮깁니다
				    da_Point.setPosition(latlng);
				    da_Point.setMap(map);
				}
			   
			    
			    $("#DA_Lat").val(latlng.getLat());
				$("#DA_Lon").val(latlng.getLng());
			
				searchDetailAddrFromCoords(mouseEvent.latLng, function(result, status) {
			        if (status === kakao.maps.services.Status.OK) {
			        	// 지번 주소정보
			        	var detailAddr = result[0].address.address_name;
			        	var addr = detailAddr.split(" ");
			        	// 시 + 군구
			        	$("#DA_addr").val(addr[0]+" "+addr[1]);
			        }
				});
			});
			function searchDetailAddrFromCoords(coords, callback) {
			    // 좌표로 법정동 상세 주소 정보를 요청합니다
			    geocoder.coord2Address(coords.getLng(), coords.getLat(), callback);
			}
		});
		
		//위험지역등록취소버튼을 눌렀을 때
		$("#bt_post_DA_Cancel").click(function(){
			$('#box_post_DA').hide();
			$("#DA_Lat").val("");
			$("#DA_Lon").val("");
			$("#DA_addr").val("");
			$("#DA_content").val("");
			$("#DA_Image").val("");
			$('#DABox').val("off");
		});
	});
	// 배열에 추가된 마커들을 지도에 표시하거나 삭제하는 함수입니다
	function setMarkers(map) {
	    for (var i = 0; i < da_makers.length; i++) {
	    	da_makers[i].setMap(map);
	    }            
	}

	// "마커 보이기" 버튼을 클릭하면 호출되어 배열에 추가된 마커를 지도에 표시하는 함수입니다
	function showMarkers() {
	    setMarkers(map)    
	}

	// "마커 감추기" 버튼을 클릭하면 호출되어 배열에 추가된 마커를 지도에서 삭제하는 함수입니다
	function hideMarkers() {
	    setMarkers(null);    
	}
	
	// 인포윈도우를 표시하는 클로저를 만드는 함수입니다 
	function makeOverListener(map, marker, infowindow) {
	    return function() {
	        infowindow.open(map, marker);
	    };
	}

	// 인포윈도우를 닫는 클로저를 만드는 함수입니다 
	function makeOutListener(infowindow) {
	    return function() {
	        infowindow.close();
	    };
	}
	
	// 라이딩 기록 공개/비공개 전환 버튼 클릭시
	function changeOpen() {
		var open = $("#bt_rr_open").val();
		if(open=='1'){
			open = 0;
		}else if(open=='0'){
			open = 1;
		}
		console.log($("#bt_rr_num").val());
		console.log(open);
		$.ajax({
			url : "/riding/update",
			type : "put",
			data : {
				rr_num : $("#bt_rr_num").val(),
				rr_open : open
			},
			dataType : "json",
			cache : false,
			success : function(data) {},
			complete : function(data){
				if(data.responseText=='y'){
					$('#bt_Open').text("비공개로 전환하기");
					$("#bt_rr_open").val(1);
				}else if(data.responseText=='n'){
					$('#bt_Open').text("공개로 전환하기");
					$("#bt_rr_open").val(0);
				}else {
					alert("에러발생!");
				}
			}
		});
	}
</script>
<footer th:replace="footer"></footer>